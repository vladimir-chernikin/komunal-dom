# ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø CLAUDE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

## 1. –Ø–ó–´–ö –û–ë–©–ï–ù–ò–Ø - –¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –í–°–Ø –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–æ–ª–∂–Ω–∞ –≤–µ—Å—Ç–∏—Å—å –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!

- ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –ü–∏—Å–∞—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –æ–±—ä—è—Å–Ω—è—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
- ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ü–∏—Å–∞—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã, –æ–±—ä—è—Å–Ω–µ–Ω–∏—è, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- ‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –ø–∏—Å–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª–∏—Ç–æ–º –∏–ª–∏ —Å —Ä—É—Å—Å–∫–∏–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º

**–ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –ö–ê–ñ–î–´–ú –û–¢–í–ï–¢–û–ú:** –Ø –ø–∏—à—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º? –ï—Å–ª–∏ –Ω–µ—Ç - –ü–ï–†–ï–ü–ò–°–ê–¢–¨!

---

## 2. –ó–ê–ü–†–ï–¢ –ù–ê –≠–ú–û–î–ó–ò

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –í –ø—Ä–æ–µ–∫—Ç–µ komunal-dom.ru –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ –≤ –∫–æ–¥–µ, —Ç–µ–∫—Å—Ç–∞—Ö –±–æ—Ç–∞ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö.

---

## 3. –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø

**–ü—Ä—è–º–æ–π, –¥–µ–ª–æ–≤–æ–π, –ø–æ –¥–µ–ª—É. –ò–∑–±–µ–≥–∞–π—Ç–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π –∏ –≤–µ–∂–ª–∏–≤–æ—Å—Ç–µ–π.**

---

## 4. –ö–ò–¢–ê–ô–°–ö–ò–ï –ò–ï–†–û–ì–õ–ò–§–´ (–î–û–ü–£–°–¢–ò–ú–û –ò–ó–†–ï–î–ö–ê)

**–†–ê–ó–†–ï–®–ï–ù–û:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∏—Ç–∞–π—Å–∫–∏–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã (Ê±âÂ≠ó - —Ö–∞–Ω—å—Ü–∑—ã) –µ—Å–ª–∏ –≤ —Å–∫–æ–±–∫–∞—Ö —É–∫–∞–∑–∞–Ω –ø–µ—Ä–µ–≤–æ–¥.

**–ü–†–ò–ú–ï–†:**
- ÂéüÂßãË¶ÅÊ±Ç (–∏—Å—Ö–æ–¥–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ) - –º–æ–∂–Ω–æ
- ÂéüÂßãË¶ÅÊ±Ç - –Ω–µ–ª—å–∑—è (–±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞)

**–ö–û–ù–¢–ï–ö–°–¢:** –†—É—Å—Å–∫–∏–µ –ª—é–±—è—Ç –ö–∏—Ç–∞–π—Ü–µ–≤ –∏ —Å—á–∏—Ç–∞—é—Ç –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –∫—Ä—É—Ç—ã–º–∏!

---

# –ò–ó–ú–ï–ù–ï–ù–ò–Ø –õ–û–ì–ò–ö–ò –§–ò–õ–¨–†–ê–¶–ò–ò –ö–ê–ù–î–ò–î–ê–¢–û–í (2025-12-24)

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ incident_type

**–î–∞—Ç–∞:** 2024-12-24
**–§–∞–π–ª:** `/var/www/komunal-dom_ru/main_agent.py`
**–°—Ç—Ä–æ–∫–∏:** 782-785

### –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:

```python
if known_incident:
    # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞
    filtered_candidates = [c for c in filtered_candidates if known_incident in c.get('incident_type', '')]
    logger.info(f"–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ incident_type={known_incident}: {len(filtered_candidates)} –∏–∑ {len(candidates_with_attrs)}")
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:

1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤** (–º–µ—Ç–æ–¥ `_extract_filters_from_message`, —Å—Ç—Ä–æ–∫–∏ 662-748):
   - **Location:** `['–∫–≤–∞—Ä—Ç–∏—Ä', '–≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ', '–≤–∞–Ω–Ω–æ–π', '–∫—É—Ö–Ω']` ‚Üí '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ'
   - **Category:** –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —É—Å–ª—É–≥
   - **Incident:** `['—Å–ª–æ–º–∞–ª', '—Ç–µ—á', '–ø—Ä–æ—Ä–≤', '–ª–æ–ø–Ω—É–ª', '—Ä–∞–∑–æ—Ä–≤']` ‚Üí '–ò–Ω—Ü–∏–¥–µ–Ω—Ç'

2. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤** (–º–µ—Ç–æ–¥ `_generate_smart_clarification`, —Å—Ç—Ä–æ–∫–∏ 773-785):
   - –°–Ω–∞—á–∞–ª–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `location_type`
   - –ó–∞—Ç–µ–º –ø–æ `category`
   - –ó–∞—Ç–µ–º –ø–æ `incident_type` (–ù–û–í–û–ï!)

3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ—Å—Ç–∞–µ—Ç—Å—è 1 –∫–∞–Ω–¥–∏–¥–∞—Ç ‚Üí SUCCESS
   - –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ‚Üí AMBIGUOUS (—É—Ç–æ—á–Ω–µ–Ω–∏–µ)
   - –ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ‚Üí –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫

---

# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–ò–°–¢–ï–ú–´

## TestBotSimulator - –ò–º–∏—Ç–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞:

```bash
cd /var/www/komunal-dom_ru
source venv/bin/activate
python test_bot_simulator.py
```

### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

**proryv_trub** - –ü—Ä–æ—Ä—ã–≤ —Ç—Ä—É–± –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ
- –•–æ–¥ 1: "–ø—Ä–∏–≤–µ—Ç"
- –•–æ–¥ 2: "—É –º–µ–Ω—è –ø—Ä–æ—Ä–≤–∞–ª–æ —Ç—Ä—É–±—É"
- –•–æ–¥ 3: "–≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ"

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ incident_type=–ò–Ω—Ü–∏–¥–µ–Ω—Ç: 2 –∏–∑ 2
–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ location_type=–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ: 2 –∏–∑ 3
–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ incident_type=–ò–Ω—Ü–∏–¥–µ–Ω—Ç: 1 –∏–∑ 3
–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ—Å—Ç–∞–ª—Å—è 1 –∫–∞–Ω–¥–∏–¥–∞—Ç: –ü—Ä–æ—Ä—ã–≤ —Ç—Ä—É–± –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ (ID: 25)
```

### –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

**SUCCESS:** –£—Å–ª—É–≥–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ
**AMBIGUOUS:** –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**ERROR:** –û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∏–∫–µ

---

# WEB-–ò–ù–¢–ï–†–§–ï–ô–° –ß–ê–¢–ê

## Django –≤–µ–±-—á–∞—Ç —Å AI-–∞–≥–µ–Ω—Ç–æ–º

### URL endpoints:

- **–°—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–∞:** http://komunal-dom.ru/chat/ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
- **API –æ—Ç–ø—Ä–∞–≤–∫–∏:** POST /chat/api/send/
- **API –∏—Å—Ç–æ—Ä–∏–∏:** GET /chat/api/history/

### –§–∞–π–ª—ã:

- `message_handler/views.py` - Django views
- `message_handler/urls.py` - URL –º–∞—Ä—à—Ä—É—Ç—ã
- `message_handler/templates/message_handler/chat.html` - UI —á–∞—Ç–∞
- `templates/base.html` - –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

1. –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç–µ (Admin_Aspect, Olga, djangoIT)
2. –û—Ç–∫—Ä—ã—Ç—å http://komunal-dom.ru/chat/
3. –ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å AI-–¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º

---

# –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò –¢–†–ê–°–°–ò–†–û–í–ö–ê –î–ò–ê–õ–û–ì–û–í

## DialogTraceService - –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ (ËøΩË∏™ÊúçÂä° - zhuƒ´z≈çng f√∫w√π)

**–§–∞–π–ª:** `/var/www/komunal-dom_ru/dialog_trace_service.py`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –í—ã–¥–∞—á–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –¥–∏–∞–ª–æ–≥–∞ –ø–æ –≤–æ—Ä–æ–Ω–∫–µ —Ç–æ—á–Ω–æ—Å—Ç–∏
- –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
- –ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ–º—Ç–æ–≤ LLM –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏ (context) –¥–∏–∞–ª–æ–≥–∞

### –ó–∞–ø—É—Å–∫ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏:

```bash
cd /var/www/komunal-dom_ru
source venv/bin/activate

# –ü–æ session_id
python dialog_trace_service.py --session-id web_123_abc

# –ü–æ telegram_user_id
python dialog_trace_service.py --telegram-user-id 123456789

# –í—ã–≤–æ–¥ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
python dialog_trace_service.py --session-id web_123_abc --output json

# –õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50)
python dialog_trace_service.py --session-id web_123_abc --limit 100
```

### –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞:

**1. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ (–≤–æ—Ä–æ–Ω–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏):**
- TagSearchService - –Ω–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–≥–∞–º
- SemanticSearchService - –ª–æ–≥–∏–∫–æ-—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
- VectorSearchService - —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ
- AIAgentService - –ø–æ–∏—Å–∫ —Å –ø–æ–º–æ—â—å—é YandexGPT
- –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤ (‰∫§ÈõÜ - jiƒÅoj√≠)

**2. LLM –ø—Ä–æ–º—Ç—ã:**
- –ì–ª–∞–≤–Ω—ã–π AI –∞–≥–µ–Ω—Ç
- –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤
- Prompt Engineering –¥–∞–Ω–Ω—ã–µ

**3. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:**
- location (–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ/–û–±—â–µ–¥–æ–º–æ–≤–æ–µ)
- category (–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ/–û—Ç–æ–ø–ª–µ–Ω–∏–µ/–∏ —Ç.–¥.)
- incident (–ò–Ω—Ü–∏–¥–µ–Ω—Ç/–ó–∞–ø—Ä–æ—Å)

**4. –ü–∞–º—è—Ç—å –¥–∏–∞–ª–æ–≥–∞:**
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏
- DialogMemoryManager —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:

```
================================================================================
–û–¢–ß–ï–¢ –¢–†–ê–°–°–ò–†–û–í–ö–ò –î–ò–ê–õ–û–ì–ê
================================================================================
Session ID: web_123_abc
–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 6

--------------------------------------------------------------------------------
–°–æ–æ–±—â–µ–Ω–∏–µ #1
–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: inbound
–¢–µ–∫—Å—Ç: —É –º–µ–Ω—è –ø—Ä–æ—Ä–≤–∞–ª–æ —Ç—Ä—É–±—É
–í—Ä–µ–º—è: 2025-12-24 08:00:00

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤:
  tag_search:
    –ù–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥: 2
      - ID:25 | –ü—Ä–æ—Ä—ã–≤ —Ç—Ä—É–± –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ | 95.00%
      - ID:26 | –û–±—â–µ–¥–æ–º–æ–≤–æ–π –ø—Ä–æ—Ä—ã–≤ —Ç—Ä—É–± | 85.00%
  vector_search:
    –ù–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥: 3
      - ID:25 | –ü—Ä–æ—Ä—ã–≤ —Ç—Ä—É–± –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ | 92.00%
      - ID:26 | –û–±—â–µ–¥–æ–º–æ–≤–æ–π –ø—Ä–æ—Ä—ã–≤ —Ç—Ä—É–± | 88.00%
      - ID:31 | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∞–Ω–∏—Ç–∞—Ä–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç | 70.00%

–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:
  location: None
  category: –í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ
  incident: –ò–Ω—Ü–∏–¥–µ–Ω—Ç
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º:

–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ "–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π —Å–∏—Å—Ç–µ–º—É" –∏—Å–ø–æ–ª—å–∑—É–π DialogTraceService:

```python
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–æ–π
python test_bot_simulator.py
python dialog_trace_service.py --session-id <session_id_–∏–∑_—Ç–µ—Å—Ç–∞>
```

---

# –ü–æ—Ä—Ç–∞–ª komunal-dom.ru –Ω–∞ Django + PostgreSQL

### ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –í—ã–∑–æ–≤—ã LLM —á–µ—Ä–µ–∑ AIAgentService

**–ü–†–ê–í–ò–õ–û:** –í—Å–µ –≤—ã–∑–æ–≤—ã LLM (YandexGPT, GPT –∏ –¥—Ä—É–≥–∏–µ) –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ `AIAgentService`.

**–ó–ê–ü–†–ï–©–ï–ù–û:**
- –ü—Ä—è–º—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ API YandexGPT –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ LLM
- –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ `_call_yandex_gpt` –≤ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö

**–ö–ê–ö –ü–†–ê–í–ò–õ–¨–ù–û:**
```python
# –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–†–ò–ú–ï–†:
class FilterDetectionService:
    def __init__(self, ai_agent_service):
        self.ai_agent = ai_agent_service

    async def detect_filters(self, message):
        prompt = self._create_prompt(message)
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º AIAgentService –¥–ª—è –≤—ã–∑–æ–≤–∞ LLM
        response, usage = await self.ai_agent._call_yandex_gpt(prompt)
        return self._parse_response(response)
```

**–ü–û–ß–ï–ú–£:**
1. –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö LLM –≤—ã–∑–æ–≤
2. –ï–¥–∏–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
3. –ï–¥–∏–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
4. –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

**–°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –°–ï–†–í–ò–°–´ –î–õ–Ø –í–´–ó–û–í–ê LLM:**
- `AIAgentService` (—Ñ–∞–π–ª: `ai_agent_service.py`) - –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô —Å–µ—Ä–≤–∏—Å –¥–ª—è –≤—ã–∑–æ–≤ LLM
  - –ú–µ—Ç–æ–¥: `_call_yandex_gpt(prompt)` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç (response_text, usage_info)
  - –õ–æ–≥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω—ã –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å
  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ API

---

## –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- **–¢–∏–ø –°–£–ë–î:** PostgreSQL 16
- **–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:** `aspect_objects_db`
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î:** `aspect_db`
- **–ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** `DB_Aspect_2025`
- **–•–æ—Å—Ç:** localhost
- **–ü–æ—Ä—Ç:** 5432
- **–°—Ç–∞—Ç—É—Å:** –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É

### 2. Django –ø—Ä–æ–µ–∫—Ç
- **–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:** `komunal_dom`
- **–í–µ—Ä—Å–∏—è Django:** 6.0
- **–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:** `venv` (–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ)
- **–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** Django, psycopg2-binary, python-decouple, gunicorn
- **SECRET_KEY:** `ZAQ12wsxZAQ12wsxZAQ12wsx`
- **DEBUG —Ä–µ–∂–∏–º:** –í–∫–ª—é—á–µ–Ω (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
- **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ö–æ—Å—Ç—ã:**
  - `komunal-dom.ru`
  - `www.komunal-dom.ru`
  - `localhost`
  - `127.0.0.1`
- **–Ø–∑—ã–∫:** –†—É—Å—Å–∫–∏–π (`ru-ru`)
- **–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:** `Europe/Moscow`
- **–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:** `.env` (—Å–æ–∑–¥–∞–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

### 4. –î–æ—Å—Ç—É–ø—ã –∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Django:**
  - –õ–æ–≥–∏–Ω: `Admin_Aspect`
  - Email: `admin@komunal-dom.ru`
  - –ü–∞—Ä–æ–ª—å: `Aspect_Admin_2025`
- **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:**
  - –õ–æ–≥–∏–Ω: `Olga`
  - Email: `olga@komunal-dom.ru`
  - –ü–∞—Ä–æ–ª—å: `OlagSuper2025`
- **–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:** http://komunal-dom.ru/admin/
- **–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä:** http://komunal-dom.ru/files/
- **–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞:** http://komunal-dom.ru/
- **–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤:** http://komunal-dom.ru/subscribers/
- **–ê–¥–º–∏–Ω–∫–∞ –£–ö:** http://komunal-dom.ru/admin-uk/

### 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–º

**–ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é:**
```bash
cd /var/www/komunal-dom_ru
source venv/bin/activate
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```bash
# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
./manage.sh run

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
./manage.sh migrate

# –°–æ–∑–¥–∞–Ω–∏–µ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
./manage.sh createsuperuser

# Django shell –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
./manage.sh shell

# –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
./manage.sh collectstatic
```

**–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Django:**
```bash
source venv/bin/activate
python manage.py runserver 0.0.0.0:8000
python manage.py makemigrations
python manage.py migrate
python manage.py createsuperuser
```

## –î–æ—Å—Ç—É–ø –∫ —Å–∞–π—Ç—É

- **–û—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç:** http://komunal-dom.ru
- **–°–∞–π—Ç —Å www:** http://www.komunal-dom.ru
- **–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:** http://komunal-dom.ru/admin/
- **–õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø:** http://komunal-dom.ru (–Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ /etc/hosts)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
/var/www/komunal-dom_ru/
‚îú‚îÄ‚îÄ venv/                    # –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ komunal_dom/            # –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç Django
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ settings.py         # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ urls.py            # URL –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ wsgi.py            # WSGI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ asgi.py            # ASGI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ manage.py              # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Django
‚îú‚îÄ‚îÄ manage.sh              # –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º
‚îú‚îÄ‚îÄ gunicorn_start.sh      # –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ gunicorn
‚îú‚îÄ‚îÄ .env                   # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ CLAUDE.md              # –≠—Ç–æ—Ç —Ñ–∞–π–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

## Production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –í–µ–±-—Å–µ—Ä–≤–µ—Ä nginx
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** `/etc/nginx/sites-available/komunal-dom.ru`
- **–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 80
- **–ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã** –Ω–∞ gunicorn (127.0.0.1:8000)

### WSGI —Å–µ—Ä–≤–µ—Ä gunicorn
- **–°–µ—Ä–≤–∏—Å systemd:** `gunicorn-komunal-dom.service`
- **–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞:** `/var/www/komunal-dom_ru/gunicorn_start.sh`
- **Workers:** 3 –ø—Ä–æ—Ü–µ—Å—Å–∞
- **Bind:** 127.0.0.1:8000
- **–°—Ç–∞—Ç—É—Å:** –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –≤–∫–ª—é—á–µ–Ω, —Å–µ—Ä–≤–∏—Å –∞–∫—Ç–∏–≤–µ–Ω

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ gunicorn
systemctl restart gunicorn-komunal-dom

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx
systemctl reload nginx

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
systemctl status gunicorn-komunal-dom nginx
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

1. **–°–æ–∑–¥–∞–Ω–∏–µ Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:**
   ```bash
   source venv/bin/activate
   python manage.py startapp <app_name>
   ```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ production —Ä–µ–∂–∏–º–∞:**
   - –û—Ç–∫–ª—é—á–∏—Ç—å DEBUG –≤ .env
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä (nginx)
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å WSGI —Å–µ—Ä–≤–µ—Ä (gunicorn)

3. **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞:**
   - –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ URL –º–∞—Ä—à—Ä—É—Ç–æ–≤
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –∏ —à–∞–±–ª–æ–Ω–æ–≤

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!

## –§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:** 100 –ú–ë
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π** –¥–ª—è —Ñ–∞–π–ª–æ–≤
- **–ü–∞–≥–∏–Ω–∞—Ü–∏—è** —Å–ø–∏—Å–∫–æ–≤ —Ñ–∞–π–ª–æ–≤
- **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø** –∫–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏
- **URL:** http://komunal-dom.ru/files/
- **–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** –î–∞
- **–î–µ–π—Å—Ç–≤–∏—è:** –ó–∞–≥—Ä—É–∑–∫–∞, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Django:** `file_manager`
- **–ú–æ–¥–µ–ª—å:** `UserFile`
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:** `/var/www/komunal-dom_ru/media/user_files/`
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ Django
## –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –¢–∏–ø—ã —Ä–æ–ª–µ–π:
1. **–ñ–∏—Ç–µ–ª—å** - –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã, –¥–æ—Å—Ç—É–ø –∫ –ª–∏—á–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É
2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ö** - —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–ø—Ä–∞–≤–ª—è—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –£–ö
3. **DBA** - –º–µ–Ω–µ–¥–∂–µ—Ä –¥–∞–Ω–Ω—ã—Ö, –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ
4. **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä Django** - –ò–¢-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç, –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º

### –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:
- **–ñ–∏—Ç–µ–ª—å:** –î–æ—Å—Ç—É–ø –∫ –ª–∏—á–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É, –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ö:** –î–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –£–ö, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏
- **DBA:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–∞–Ω–Ω—ã—Ö, –¥–æ—Å—Ç—É–ø –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
- **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä Django:** –ü–æ–ª–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø, –ø—Ä–∞–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤

### –¢–µ–∫—É—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
- **Admin_Aspect:** –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä Django (–ø–∞—Ä–æ–ª—å: Aspect_Admin_2025)
- **Olga:** DBA - –º–µ–Ω–µ–¥–∂–µ—Ä –¥–∞–Ω–Ω—ã—Ö (–ø–∞—Ä–æ–ª—å: OlagSuper2025)
- **djangoIT:** –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä Django (–ø–∞—Ä–æ–ª—å: 2)
- **tstDBA:** DBA - –º–µ–Ω–µ–¥–∂–µ—Ä –¥–∞–Ω–Ω—ã—Ö (–ø–∞—Ä–æ–ª—å: 2)
- **tstUser:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ö (–ø–∞—Ä–æ–ª—å: 2)
- **resident1:** –ñ–∏—Ç–µ–ª—å (–ø–∞—Ä–æ–ª—å: 2)

## Telegram –±–æ—Ç "–°–∏–≥–∏–∑–º—É–Ω–¥ –õ–∞–∑–æ—Ä–µ–≤–∏—á"

### –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** –°–∏–≥–∏–∑–º—É–Ω–¥ –õ–∞–∑–æ—Ä–µ–≤–∏—á
- **–¢–æ–∫–µ–Ω:** `8262936710:AAGza7Iz5UBeRfyXZFazudP_N8sy1gbahAg`
- **Username:** @KomunalkaProblemBot
- **–§–∞–π–ª:** `/var/www/komunal-dom_ru/address_bot.py`
- **–°–µ—Ä–≤–∏—Å:** `address-bot.service`

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–æ–≤** –≤ –∑–æ–Ω–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –£–ö "–ê—Å–ø–µ–∫—Ç"
- **–ê–Ω–∞–ª–∏–∑ –∞–¥—Ä–µ—Å–æ–≤** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AI
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –ö–õ–ê–î–†
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞** —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞

### API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- **YandexGPT API:** ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω –∏ —Ä–∞–±–æ—á–∏–π
  - **API Key:** `(—Å–º. .env —Ñ–∞–π–ª)`
  - **Folder ID:** `(—Å–º. .env —Ñ–∞–π–ª)`
  - **–ú–æ–¥–µ–ª—å:** `yandexgpt-lite`
  - **–°—Ç–∞—Ç—É—Å:** –ü–æ–¥–∫–ª—é—á–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
  - **–†–∞—Å—Ö–æ–¥—ã:** ~0.20 ‚ÇΩ –∑–∞ 1,000 —Ç–æ–∫–µ–Ω–æ–≤
  - **Free tier:** 3,000 ‚ÇΩ/–º–µ—Å—è—Ü

- **Gemini API:** ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ä–µ–≥–∏–æ–Ω—É
  - **–ö–ª—é—á:** `(—Å–º. .env —Ñ–∞–π–ª)`
  - **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –†–æ—Å—Å–∏–∏

- **z.ai API:** ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–æ–≤—ã–π –∫–ª—é—á
  - **–ü—Ä–æ–±–ª–µ–º–∞:** –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤
- **–ò—Å—Ç–æ—á–Ω–∏–∫:** –ö–õ–ê–î–† (–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–¥—Ä–µ—Å–æ–≤ –†–æ—Å—Å–∏–∏)
- **–ó–∞–ø–∏—Å–µ–π:** 2,615 –∞–¥—Ä–µ—Å–æ–≤
- **–¢–∞–±–ª–∏—Ü—ã:** `kladr_address_objects`, `buildings`, `kladr_types`
- **–ü–æ–∫—Ä—ã—Ç–∏–µ:** –ü–æ–ª–Ω—É—é –±–∞–∑—É –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
systemctl status address-bot

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
systemctl restart address-bot

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
journalctl -u address-bot -f
```

### –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
- `/start` - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- `/help` - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞** - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ .env
```
YANDEX_API_KEY=(—Å–º. .env —Ñ–∞–π–ª)
YANDEX_FOLDER_ID=(—Å–º. .env —Ñ–∞–π–ª)
```

## –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–æ—Ç–∞ —É–ø—Ä–∞–≤–ª—è—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏

### –°—Ç–∞—Ç—É—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ –¢–ó (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-12-18)

**–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–∑—ã:**
- ‚úÖ **–ß–∞—Å—Ç—å 0:** –û–±–∑–æ—Ä –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ - –≥–æ—Ç–æ–≤–∞
- ‚úÖ **–ß–∞—Å—Ç—å 1:** DialogMemoryManager - –≥–æ—Ç–æ–≤–∞
- ‚úÖ **–ß–∞—Å—Ç—å 2:** AntiSpamFilter —Å 4 —É—Ä–æ–≤–Ω—è–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ - –≥–æ—Ç–æ–≤–∞
- ‚ö†Ô∏è **–ß–∞—Å—Ç—å 3:** AddressExtractor - –ü–†–ï–†–í–ê–ù–ê –Ω–∞ –º–µ—Ç–æ–¥–µ accumulate_address_fragments()

**–û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ñ–∞–∑—ã:**
- ‚è≥ **–ß–∞—Å—Ç—å 4:** AICostTrackingService - –≤ –æ—á–µ—Ä–µ–¥–∏
- ‚è≥ **–ß–∞—Å—Ç—å 5:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ë–î - –≤ –æ—á–µ—Ä–µ–¥–∏
- ‚è≥ **–ß–∞—Å—Ç—å 6:** –§–∏–Ω–∞–ª—å–Ω—ã–π JSON - –≤ –æ—á–µ—Ä–µ–¥–∏

### –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞:

**–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–±–ª–µ–º–∞:** –í—ã–ª–µ—Ç –Ω–∞ **–ß–∞—Å—Ç–∏ 3 (–§–∞–∑–∞ 3)** –≤ –º–µ—Ç–æ–¥–µ `accumulate_address_fragments()` - –∫–ª—é—á–µ–≤–æ–º –º–µ—Ç–æ–¥–µ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–æ–≤ –∏–∑ –∫—É—Å–∫–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å:** –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –ø—Ä–µ—Ä–≤–∞–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –ß–∞—Å—Ç–∏ 3, –∑–∞–≤–µ—Ä—à–∏—Ç—å AddressExtractor, –∑–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ß–∞—Å—Ç–∏ 4-6 –ø–æ –ø–æ—Ä—è–¥–∫—É.

### –§–∞–∑–∞ 2: AntiSpamFilter —Å 4 —É—Ä–æ–≤–Ω—è–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ê

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-12-18

#### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

1. **–£–†–û–í–ï–ù–¨ 1: –ë–∞–∑–æ–≤—ã–π —Å–ø–∞–º-–¥–µ—Ç–µ–∫—Ç–æ—Ä**
   - –î–µ—Ç–µ–∫—Ü–∏—è —Å–ø–∞–º-–∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ URL –∏ —Å—Å—ã–ª–∫–∏
   - –ê–Ω–∞–ª–∏–∑ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–∏–º–≤–æ–ª–æ–≤
   - –î–µ—Ç–µ–∫—Ü–∏—è –∫–∞–ø—Å–ª–æ–∫–∞ –∏ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤

2. **–£–†–û–í–ï–ù–¨ 2: –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä—É–≥–∞—Ç–µ–ª—å—Å—Ç–≤ (PROFANITY)**
   - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω–æ–π –ª–µ–∫—Å–∏–∫–∏
   - –ü–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä—É–≥–∞—Ç–µ–ª—å—Å—Ç–≤
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ (severity)
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å pymorphy2 –¥–ª—è –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

3. **–£–†–û–í–ï–ù–¨ 3: –î–µ—Ç–µ–∫—Ç–æ—Ä –Ω–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (NON_CONSTRUCTIVE)**
   - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:
     - –ü—Ä—è–º—ã–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è
     - –ù–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–∞—è –∫—Ä–∏—Ç–∏–∫–∞
     - –£–≥—Ä–æ–∑—ã –∏ –¥–∞–≤–ª–µ–Ω–∏–µ
     - –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤—Å–ø–ª–µ—Å–∫–∏
     - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
     - –ü–∞—Å—Å–∏–≤–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏—è
     - –û–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ
     - –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏
   - –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ (severity 0.5-1.0)
   - –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤, –∫–∞–ø—Å–ª–æ–∫, –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏)

4. **–£–†–û–í–ï–ù–¨ 4: –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (VAGUE)**
   - –î–µ—Ç–µ–∫—Ü–∏—è –æ–¥–Ω–æ—Å–ª–æ–∂–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π
   - –ê–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏
   - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –∏ –Ω–µ–ø–æ–ª–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - –£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏ vs —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç–æ—Å—Ç–∏

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ —Ñ–∏–ª—å—Ç—Ä–∞:
```json
{
  "is_spam": bool,
  "reason": str,
  "confidence": float,
  "category": str,     // OK | SPAM | PROFANITY | NON_CONSTRUCTIVE | VAGUE
  "action": str,       // PROCESS | REJECT | WARN_AND_RETRY | ASK_FOR_CLARIFICATION
  "details": dict      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
}
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- ‚úÖ –í—Å–µ 8 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –¢–æ—á–Ω–æ—Å—Ç—å –¥–µ—Ç–µ–∫—Ü–∏–∏: 100%
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

#### –§–∞–π–ª—ã:
- **–û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å:** `/var/www/komunal-dom_ru/service_detection_modules.py`
- **–¢–µ—Å—Ç—ã:** `/var/www/komunal-dom_ru/test_phase2.py`
- **–†–∞–∑–º–µ—Ä –º–æ–¥—É–ª—è:** ~40,000+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

## –í–û–†–û–ù–ö–ê –¢–û–ß–ù–û–°–¢–ò - –°–ò–°–¢–ï–ú–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –£–°–õ–£–ì

### –°—Ç–∞—Ç—É—Å: ‚úÖ **–ó–ê–í–ï–†–®–ï–ù–û –ò –†–ê–ë–û–¢–ê–ï–¢**

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-12-19

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–æ—Ä–æ–Ω–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
1. **MainAgent** (`main_agent.py`) - –≥–ª–∞–≤–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
2. **TagSearchService** (`tag_search_service.py`) - –Ω–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–≥–∞–º
3. **SemanticSearchService** (`semantic_search_service.py`) - –ª–æ–≥–∏–∫–æ-—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
4. **VectorSearchService** (`vector_search_service.py`) - —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ
5. **AIAgentService** (`ai_agent_service.py`) - –ø–æ–∏—Å–∫ —Å –ø–æ–º–æ—â—å—é YandexGPT

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:

#### 1. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤:
```python
search_tasks = []
if self.tag_search: search_tasks.append(self._run_tag_search(message_text))
if self.semantic_search: search_tasks.append(self._run_semantic_search(message_text))
if self.vector_search: search_tasks.append(self._run_vector_search(message_text))
if self.ai_agent: search_tasks.append(self._run_ai_search(message_text))
search_results = await asyncio.gather(*search_tasks, return_exceptions=True)
```

#### 2. –°–±–æ—Ä –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
- –ö–∞–∂–¥—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON: `{[–ö–æ–¥–£—Å–ª—É–≥–∏], [–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å–ü—Ä–æ—Ü–µ–Ω—Ç]}`
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ—Ä–æ–≥—É —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ 75%
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ü–æ–≤—ã—à–µ–Ω–∏–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è—Ö –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

#### 3. –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π:
- **–û–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (1 –∫–∞–Ω–¥–∏–¥–∞—Ç):** SUCCESS ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
- **–ù–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:** AMBIGUOUS ‚Üí —É—Ç–æ—á–Ω–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:** AMBIGUOUS ‚Üí –∑–∞–ø—Ä–æ—Å —É—Ç–æ—á–Ω–µ–Ω–∏—è

### –§–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤:
```json
{
  "status": "success",
  "candidates": [
    {
      "service_id": 5,
      "service_name": "–°–ª–æ–º–∞–ª—Å—è –ª–∏—Ñ—Ç",
      "confidence": 1.0,
      "source": "tag_search"
    }
  ],
  "method": "tag_search"
}
```

### –§–æ—Ä–º–∞—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ MainAgent:
```json
{
  "status": "SUCCESS",
  "service_id": 5,
  "service_name": "–°–ª–æ–º–∞–ª—Å—è –ª–∏—Ñ—Ç",
  "confidence": 1.0,
  "source": "tag_search+vector_search",
  "message": "–Ø –æ–ø—Ä–µ–¥–µ–ª–∏–ª, —á—Ç–æ —É –≤–∞—Å –ø—Ä–æ–±–ª–µ–º–∞: –°–ª–æ–º–∞–ª—Å—è –ª–∏—Ñ—Ç",
  "candidates": [...],
  "needs_confirmation": false
}
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥:
- **–¢–∞–±–ª–∏—Ü–∞:** `services`
- **–ü–æ–ª—è:** id, name, category, object_type, incident_type, location_type, tags, keywords
- **–¢–µ—Å—Ç–æ–≤—ã–µ —É—Å–ª—É–≥–∏:** 7 —É—Å–ª—É–≥ (–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—á–∏, –ó–∞—Å–æ—Ä –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏, –û—Ç–æ–ø–ª–µ–Ω–∏–µ, –õ–∏—Ñ—Ç, –∏ –¥—Ä.)

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- ‚úÖ **"—Å–ª–æ–º–∞–ª—Å—è –ª–∏—Ñ—Ç"** ‚Üí SUCCESS (100% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, tag_search+vector_search)
- ‚úÖ **"–Ω–µ—Ç –æ—Ç–æ–ø–ª–µ–Ω–∏—è"** ‚Üí SUCCESS (99.2% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, tag_search+vector_search)
- ‚ö†Ô∏è **"–æ—Ç–∫—Ä—ã–ª–∞—Å—å —Ç–µ—á—å"** ‚Üí AMBIGUOUS (–ø–æ—Ä–æ–≥ 75% —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π –¥–ª—è 50% —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è)

### –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:
- ‚úÖ **Async/await –ø—Ä–æ–±–ª–µ–º—ã:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é `sync_to_async` –∏ `asyncio.to_thread`
- ‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥:** –°–æ–∑–¥–∞–Ω–∞ –∏ populated
- ‚úÖ **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å –ø–æ–≤—ã—à–µ–Ω–∏–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
- ‚ö†Ô∏è **AIAgentService:** –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º event loop (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ)

### –§–∞–π–ª—ã –≤–æ—Ä–æ–Ω–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏:
- **MainAgent:** `/var/www/komunal-dom_ru/main_agent.py`
- **TagSearchService:** `/var/www/komunal-dom_ru/tag_search_service.py`
- **SemanticSearchService:** `/var/www/komunal-dom_ru/semantic_search_service.py`
- **VectorSearchService:** `/var/www/komunal-dom_ru/vector_search_service.py`
- **AIAgentService:** `/var/www/komunal-dom_ru/ai_agent_service.py`

**–ò–¢–û–ì: –í–æ—Ä–æ–Ω–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –±–æ—Ç–µ!**

## –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ó–∞–ø—Ä–µ—Ç –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏
**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –í –ø—Ä–æ–µ–∫—Ç–µ komunal-dom.ru –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ –≤ –∫–æ–¥–µ, —Ç–µ–∫—Å—Ç–∞—Ö –±–æ—Ç–∞ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö.

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –≥–æ–≤–æ—Ä–∏—Ç—å –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –∞ –Ω–µ –∫–∞–∫ —Ä–æ–±–æ—Ç
- –≠–º–æ–¥–∑–∏ –Ω–∞—Ä—É—à–∞—é—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è
- –ò–∑–±–µ–≥–∞–µ–º –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º—É —Å—Ç–∏–ª—é

**–ü—Ä–∞–≤–∏–ª–∞:**
- –í—Å–µ —Ç–µ–∫—Å—Ç—ã –±–æ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–µ–∑ —ç–º–æ–¥–∑–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ, –ø–æ–Ω—è—Ç–Ω—ã–µ —Ñ—Ä–∞–∑—ã
- –ò–∑–±–µ–≥–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π –∏ –≤–µ–∂–ª–∏–≤–æ—Å—Ç–µ–π
- –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: –ø—Ä—è–º–æ–π, –¥–µ–ª–æ–≤–æ–π, –ø–æ –¥–µ–ª—É

**–ü—Ä–∏–º–µ—Ä –ü–†–ê–í–ò–õ–¨–ù–û:**
```
"–ü–æ–Ω—è–ª –ø—Ä–æ–±–ª–µ–º—É: –ó–∞—Å–æ—Ä –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏"
"–ì–¥–µ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?"
"–£—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã."
```

**–ü—Ä–∏–º–µ—Ä –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:**
```
"üîç –ü–æ–Ω—è–ª –ø—Ä–æ–±–ª–µ–º—É: –ó–∞—Å–æ—Ä –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ üíß"
"ü§î –ì–¥–µ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ? üìç"
"üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã! ‚ú®"
```
