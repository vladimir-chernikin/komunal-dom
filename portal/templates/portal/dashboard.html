{% extends 'portal/base.html' %}

{% block title %}Личный кабинет - ООО "Аспект"{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header {% if user_role == 'django_admin' %}bg-danger{% elif user_role == 'dba' %}bg-warning{% else %}bg-success{% endif %} text-white">
                    <h2 class="mb-0">
                        <i class="fas fa-user"></i> Личный кабинет
                    </h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Чат будет здесь -->
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-robot"></i> AI Диспетчер
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-3">Опишите вашу проблему, и AI поможет определить нужную услугу.</p>
                                    <a href="{% url 'message_handler:chat_interface' %}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-comments"></i> Открыть чат с диспетчером
                                    </a>
                                </div>
                            </div>

                            <!-- Дополнительные функции для администраторов -->
                            {% if user_role == 'django_admin' or user_role == 'dba' %}
                            <div class="mt-4">
                                <h5 class="mb-3">
                                    <i class="fas fa-cogs"></i> Административные функции
                                </h5>
                                <div class="row">
                                    {% if user_role == 'django_admin' %}
                                    <div class="col-md-4 mb-3">
                                        <a href="/admin/" class="btn btn-danger btn-lg w-100">
                                            <i class="fas fa-cogs"></i><br>
                                            <small>Админ панель Django</small>
                                        </a>
                                    </div>
                                    {% endif %}

                                    <div class="col-md-4 mb-3">
                                        <a href="{% url 'file_manager:all_files' %}" class="btn btn-primary btn-lg w-100">
                                            <i class="fas fa-folder"></i><br>
                                            <small>Все файлы системы</small>
                                        </a>
                                    </div>

                                    {% if user_role == 'django_admin' %}
                                    <div class="col-md-4 mb-3">
                                        <a href="{% url 'portal:admin_page' %}" class="btn btn-warning btn-lg w-100">
                                            <i class="fas fa-users"></i><br>
                                            <small>Пользователи системы</small>
                                        </a>
                                    </div>
                                    {% elif user_role == 'dba' %}
                                    <div class="col-md-4 mb-3">
                                        <a href="{% url 'portal:dba_page' %}" class="btn btn-warning btn-lg w-100">
                                            <i class="fas fa-database"></i><br>
                                            <small>Панель DBA</small>
                                        </a>
                                    </div>
                                    {% endif %}
                                    {% if user_role == 'django_admin' or user_role == 'dba' %}
                                    <div class="col-md-4 mb-3">
                                        <a href="{% url 'portal:kladr_management' %}" class="btn btn-success btn-lg w-100">
                                            <i class="fas fa-map"></i><br>
                                            <small>Управление КЛАДР</small>
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Статистика для администраторов -->
                            <div class="mt-4">
                                <h5 class="mb-3">
                                    <i class="fas fa-chart-bar"></i> Статистика
                                </h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h4 class="text-primary">{{ total_users }}</h4>
                                                <p class="mb-0">Всего пользователей</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h4 class="text-warning">{{ dba_count }}</h4>
                                                <p class="mb-0">Менеджеров</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h4 class="text-info">{{ uk_user_count }}</h4>
                                                <p class="mb-0">Сотрудников УК</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h4 class="text-secondary">{{ resident_count }}</h4>
                                                <p class="mb-0">Жителей</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Статистика по КЛАДР для администраторов -->
                                {% if user_role == 'django_admin' or user_role == 'dba' %}
                                <h5 class="mb-3 mt-4">
                                    <i class="fas fa-map"></i> Адресная база КЛАДР
                                </h5>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h4 class="text-primary">{{ kladr_stats.address_objects|default:"-" }}</h4>
                                                <p class="mb-0">Адресных объектов</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h4 class="text-success">{{ kladr_stats.buildings|default:"-" }}</h4>
                                                <p class="mb-0">Зданий</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h4 class="text-warning">{{ kladr_stats.service_areas|default:"-" }}</h4>
                                                <p class="mb-0">Зон обслуживания</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-user"></i> Ваш профиль
                                    </h5>
                                </div>
                                <div class="card-body text-center">
                                    <i class="fas fa-user-circle fa-4x text-muted mb-3"></i>
                                    <p class="text-muted">{{ user.username }}</p>
                                    <span class="badge {% if user_role == 'django_admin' %}bg-danger{% elif user_role == 'dba' %}bg-warning{% else %}bg-info{% endif %} fs-6">
                                        {% if user_role == 'django_admin' %}
                                            Администратор Django
                                        {% elif user_role == 'dba' %}
                                            DBA - Менеджер данных
                                        {% else %}
                                            Сотрудник УК
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <!-- Ваши данные - перемещено под профиль -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-id-card"></i> Ваши данные
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td class="text-muted"><strong>Логин:</strong></td>
                                            <td>{{ user.username }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted"><strong>Email:</strong></td>
                                            <td>{{ user.email|default:"-" }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted"><strong>Роль:</strong></td>
                                            <td>
                                                <span class="badge {% if user_role == 'django_admin' %}bg-danger{% elif user_role == 'dba' %}bg-warning{% else %}bg-info{% endif %}">
                                                    {% if user_role == 'django_admin' %}
                                                        Администратор Django
                                                    {% elif user_role == 'dba' %}
                                                        DBA - Менеджер данных
                                                    {% else %}
                                                        Сотрудник УК
                                                    {% endif %}
                                                </span>
                                            </td>
                                        </tr>
                                        {% if user_profile.phone %}
                                        <tr>
                                            <td class="text-muted"><strong>Телефон:</strong></td>
                                            <td>{{ user_profile.phone }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if user_profile.address %}
                                        <tr>
                                            <td class="text-muted"><strong>Адрес:</strong></td>
                                            <td>{{ user_profile.address }}</td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <td class="text-muted"><strong>Регистрация:</strong></td>
                                            <td>{{ user.date_joined|date:"d.m.Y" }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-link"></i> Быстрые ссылки
                                    </h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="{% url 'message_handler:chat_interface' %}" class="list-group-item list-group-item-action">
                                            <i class="fas fa-robot"></i> AI Чат диспетчера
                                        </a>
                                        <a href="{% url 'file_manager:file_list' %}" class="list-group-item list-group-item-action">
                                            <i class="fas fa-folder"></i> Мои файлы
                                        </a>
                                        <a href="/subscribers/" class="list-group-item list-group-item-action">
                                            <i class="fas fa-users"></i> Абоненты
                                        </a>
                                        {% if user_role == 'django_admin' or user_role == 'dba' %}
                                        <a href="{% url 'portal:kladr_management' %}" class="list-group-item list-group-item-action">
                                            <i class="fas fa-map"></i> Управление КЛАДР
                                        </a>
                                        {% endif %}
                                        {% if user_role == 'django_admin' %}
                                        <a href="/admin/" class="list-group-item list-group-item-action">
                                            <i class="fas fa-cog"></i> Django Админ
                                        </a>
                                        {% endif %}
                                        {% if user_role == 'django_admin' %}
                                        <a href="{% url 'portal:admin_page' %}" class="list-group-item list-group-item-action">
                                            <i class="fas fa-users-cog"></i> Управление пользователями
                                        </a>
                                        {% elif user_role == 'dba' %}
                                        <a href="{% url 'portal:dba_page' %}" class="list-group-item list-group-item-action">
                                            <i class="fas fa-database"></i> Панель DBA
                                        </a>
                                        {% endif %}
                                        {% if user_role == 'django_admin' or user_role == 'dba' %}
                                        <a href="{% url 'portal:prompt_management' %}" class="list-group-item list-group-item-action">
                                            <i class="fas fa-robot"></i> AI промпты
                                        </a>
                                        {% endif %}
                                        <a href="/logout/" class="list-group-item list-group-item-action text-danger">
                                            <i class="fas fa-sign-out-alt"></i> Выйти
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Информация о системе для DBA -->
                            {% if user_role == 'django_admin' or user_role == 'dba' %}
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-info-circle"></i> Система
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <h6>Telegram бот:</h6>
                                    <p class="small mb-1">
                                        <i class="fas fa-robot text-success"></i>
                                        Статус: <span class="badge bg-success">Активен</span>
                                    </p>
                                    <p class="small mb-0">Имя: Сигизмунд Лазоревич</p>

                                    <h6 class="mt-3">База данных:</h6>
                                    <p class="small mb-1">
                                        <i class="fas fa-database text-primary"></i>
                                        Тип: PostgreSQL
                                    </p>
                                    <p class="small mb-0">
                                        <i class="fas fa-map text-info"></i>
                                        Адресов: <strong>{{ kladr_stats.address_objects|default:"-" }}</strong>
                                    </p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}