#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ —É—Å–ª—É–≥
"""

import os
import sys

# Django setup
sys.path.append('/var/www/komunal-dom_ru')
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'komunal_dom.settings')

import django
django.setup()

from django.db import connection

def add_test_data():
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏"""

    try:
        with connection.cursor() as cursor:

            print("üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ç–µ–≥–æ–≤...")

            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥–∏
            tags_data = [
                ('–≤–æ–¥–∞', 1.8),
                ('—Ç–µ—á—å', 2.0),
                ('–ø—Ä–æ—Ç–µ—á–∫–∞', 1.9),
                ('–∫—Ä–∞–Ω', 1.5),
                ('—Ä–∞–∫–æ–≤–∏–Ω–∞', 1.3),
                ('–∑–∞—Å–æ—Ä', 1.8),
                ('–∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è', 1.6),
                ('–±–∞—Ç–∞—Ä–µ—è', 1.4),
                ('–æ—Ç–æ–ø–ª–µ–Ω–∏–µ', 1.7),
                ('—Å–≤–µ—Ç', 1.5),
                ('—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', 1.6),
                ('—Ä–æ–∑–µ—Ç–∫–∞', 1.3),
                ('–ª–∞–º–ø–æ—á–∫–∞', 1.2),
                ('–ª–∏—Ñ—Ç', 1.4),
                ('–¥–≤–µ—Ä—å', 1.3),
                ('–∑–∞–º–æ–∫', 1.2),
                ('–∫—Ä—ã—à–∞', 1.5),
                ('–ø–æ—Ç–æ–ª–æ–∫', 1.4),
                ('–æ–∫–Ω–æ', 1.3),
                ('—Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞', 1.6),
            ]

            for tag_name, weight in tags_data:
                cursor.execute("""
                    INSERT INTO ref_tags (tag_name, weight_coefficient, is_active)
                    VALUES (%s, %s, TRUE)
                    ON CONFLICT DO NOTHING
                """, [tag_name, weight])

            print("‚úÖ –¢–µ–≥–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")

            print("üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —É—Å–ª—É–≥...")

            # –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥–∏
            services_data = [
                ('WAT-AVR-001', '–ü—Ä–æ—Ä—ã–≤ —Ç—Ä—É–± –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ', 7, 1, 1, 21, 1,
                 '–°—Ä–æ—á–Ω–∞—è –∑–∞–º–µ–Ω–∞ –∏–ª–∏ —Ä–µ–º–æ–Ω—Ç —Ç—Ä—É–± –≤–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏—è –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ'),
                ('WAT-S2-001', '–£—Ç–µ—á–∫–∞ –∏–∑ –∫—Ä–∞–Ω–∞', 7, 2, 1, 22, 1,
                 '–†–µ–º–æ–Ω—Ç –∏–ª–∏ –∑–∞–º–µ–Ω–∞ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ–≥–æ –∫—Ä–∞–Ω–∞'),
                ('WAT-S2-002', '–ó–∞—Å–æ—Ä —Ä–∞–∫–æ–≤–∏–Ω—ã', 7, 2, 1, 23, 1,
                 '–ü—Ä–æ—á–∏—Å—Ç–∫–∞ –∑–∞—Å–æ—Ä–∞ –≤ —Ä–∞–∫–æ–≤–∏–Ω–µ'),
                ('HEAT-AVR-001', '–ü—Ä–æ—Ä—ã–≤ –±–∞—Ç–∞—Ä–µ–∏ –æ—Ç–æ–ø–ª–µ–Ω–∏—è', 6, 1, 1, 10, 1,
                 '–°—Ä–æ—á–Ω—ã–π —Ä–µ–º–æ–Ω—Ç —Ä–∞–¥–∏–∞—Ç–æ—Ä–∞ –æ—Ç–æ–ø–ª–µ–Ω–∏—è'),
                ('HEAT-S2-001', '–ù–µ—Ç –æ—Ç–æ–ø–ª–µ–Ω–∏—è', 6, 2, 1, 11, 1,
                 '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –æ—Ç–æ–ø–ª–µ–Ω–∏—è'),
                ('EL-AVR-001', '–ù–µ—Ç —Å–≤–µ—Ç–∞ –≤–æ –≤—Å–µ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ', 4, 1, 1, 12, 1,
                 '–°—Ä–æ—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏—è'),
                ('EL-S2-001', '–ü–µ—Ä–µ–≥–æ—Ä–µ–ª–∞ –ª–∞–º–ø–æ—á–∫–∞', 4, 2, 2, 13, 1,
                 '–ó–∞–º–µ–Ω–∞ –ª–∞–º–ø—ã –æ—Å–≤–µ—â–µ–Ω–∏—è'),
                ('EL-S2-002', '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–æ–∑–µ—Ç–∫–∞', 4, 2, 2, 14, 1,
                 '–†–µ–º–æ–Ω—Ç –∏–ª–∏ –∑–∞–º–µ–Ω–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π —Ä–æ–∑–µ—Ç–∫–∏'),
                ('ELV-AVR-001', '–õ–∏—Ñ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', 9, 1, 1, 15, 1,
                 '–°—Ä–æ—á–Ω—ã–π —Ä–µ–º–æ–Ω—Ç –ª–∏—Ñ—Ç–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è'),
                ('STR-AVR-001', '–ü—Ä–æ—Ç–µ—á–∫–∞ –∫—Ä—ã—à–∏', 5, 1, 1, 16, 1,
                 '–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ç–µ—á–∫–∏ –∫—Ä–æ–≤–ª–∏'),
                ('STR-S2-001', '–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–æ –æ–∫–Ω–æ', 5, 2, 1, 17, 1,
                 '–†–µ–º–æ–Ω—Ç –∏–ª–∏ –∑–∞–º–µ–Ω–∞ –æ–∫–æ–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞'),
                ('STR-S2-002', '–ü—Ä–æ–±–ª–µ–º–∞ —Å –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä—å—é', 5, 2, 1, 18, 1,
                 '–†–µ–º–æ–Ω—Ç –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä–∏ –∏–ª–∏ –∑–∞–º–∫–∞'),
                ('CONS-AVR-001', '–ó–∞—Ç–æ–ø–ª–µ–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã', 1, 1, 1, 19, 1,
                 '–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π –∑–∞—Ç–æ–ø–ª–µ–Ω–∏—è'),
            ]

            for scenario_id, scenario_name, category_id, kind_id, type_id, object_id, localization_id, description in services_data:
                cursor.execute("""
                    INSERT INTO services_catalog
                    (scenario_id, scenario_name, category_id, kind_id, type_id, object_id, localization_id,
                     payment_id, route_id, urgency_id, is_active, description_for_search)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, 1, 1, 1, TRUE, %s)
                    ON CONFLICT (scenario_id) DO UPDATE SET
                        scenario_name = EXCLUDED.scenario_name,
                        description_for_search = EXCLUDED.description_for_search
                """, [scenario_id, scenario_name, category_id, kind_id, type_id, object_id, localization_id,
                      description])

            print("‚úÖ –£—Å–ª—É–≥–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")

            print("üîß –°–≤—è–∑—ã–≤–∞–µ–º —Ç–µ–≥–∏ —Å —É—Å–ª—É–≥–∞–º–∏...")

            # –°–≤—è–∑—ã–≤–∞–µ–º —Ç–µ–≥–∏ —Å —É—Å–ª—É–≥–∞–º–∏ –ø–æ scenario_id
            tag_service_links = [
                # –ü—Ä–æ—Ä—ã–≤ —Ç—Ä—É–± - –≤–æ–¥–∞, —Ç–µ—á—å, –ø—Ä–æ—Ç–µ—á–∫–∞, —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞
                ('WAT-AVR-001', ['–≤–æ–¥–∞', '—Ç–µ—á—å', '–ø—Ä–æ—Ç–µ—á–∫–∞', '—Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞']),
                # –£—Ç–µ—á–∫–∞ –∏–∑ –∫—Ä–∞–Ω–∞ - –≤–æ–¥–∞, —Ç–µ—á—å, –∫—Ä–∞–Ω, —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞
                ('WAT-S2-001', ['–≤–æ–¥–∞', '—Ç–µ—á—å', '–∫—Ä–∞–Ω', '—Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞']),
                # –ó–∞—Å–æ—Ä —Ä–∞–∫–æ–≤–∏–Ω—ã - –∑–∞—Å–æ—Ä, —Ä–∞–∫–æ–≤–∏–Ω–∞, –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è, —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞
                ('WAT-S2-002', ['–∑–∞—Å–æ—Ä', '—Ä–∞–∫–æ–≤–∏–Ω–∞', '–∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è', '—Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞']),
                # –ü—Ä–æ—Ä—ã–≤ –±–∞—Ç–∞—Ä–µ–∏ - –±–∞—Ç–∞—Ä–µ—è, –æ—Ç–æ–ø–ª–µ–Ω–∏–µ, —Ç–µ—á—å, –≤–æ–¥–∞
                ('HEAT-AVR-001', ['–±–∞—Ç–∞—Ä–µ—è', '–æ—Ç–æ–ø–ª–µ–Ω–∏–µ', '—Ç–µ—á—å', '–≤–æ–¥–∞']),
                # –ù–µ—Ç –æ—Ç–æ–ø–ª–µ–Ω–∏—è - –æ—Ç–æ–ø–ª–µ–Ω–∏–µ, –±–∞—Ç–∞—Ä–µ—è
                ('HEAT-S2-001', ['–æ—Ç–æ–ø–ª–µ–Ω–∏–µ', '–±–∞—Ç–∞—Ä–µ—è']),
                # –ù–µ—Ç —Å–≤–µ—Ç–∞ - —Å–≤–µ—Ç, —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ
                ('EL-AVR-001', ['—Å–≤–µ—Ç', '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ']),
                # –õ–∞–º–ø–æ—á–∫–∞ - —Å–≤–µ—Ç, –ª–∞–º–ø–æ—á–∫–∞, —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ
                ('EL-S2-001', ['—Å–≤–µ—Ç', '–ª–∞–º–ø–æ—á–∫–∞', '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ']),
                # –†–æ–∑–µ—Ç–∫–∞ - —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ, —Ä–æ–∑–µ—Ç–∫–∞
                ('EL-S2-002', ['—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', '—Ä–æ–∑–µ—Ç–∫–∞']),
                # –õ–∏—Ñ—Ç - –ª–∏—Ñ—Ç
                ('ELV-AVR-001', ['–ª–∏—Ñ—Ç']),
                # –ü—Ä–æ—Ç–µ—á–∫–∞ –∫—Ä—ã—à–∏ - –∫—Ä—ã—à–∞, –ø–æ—Ç–æ–ª–æ–∫, —Ç–µ—á—å, –ø—Ä–æ—Ç–µ—á–∫–∞
                ('STR-AVR-001', ['–∫—Ä—ã—à–∞', '–ø–æ—Ç–æ–ª–æ–∫', '—Ç–µ—á—å', '–ø—Ä–æ—Ç–µ—á–∫–∞']),
                # –û–∫–Ω–æ - –æ–∫–Ω–æ
                ('STR-S2-001', ['–æ–∫–Ω–æ']),
                # –í—Ö–æ–¥–Ω–∞—è –¥–≤–µ—Ä—å - –¥–≤–µ—Ä—å, –∑–∞–º–æ–∫
                ('STR-S2-002', ['–¥–≤–µ—Ä—å', '–∑–∞–º–æ–∫']),
                # –ó–∞—Ç–æ–ø–ª–µ–Ω–∏–µ - –≤–æ–¥–∞, –ø—Ä–æ—Ç–µ—á–∫–∞, —Ç–µ—á—å, –ø–æ—Ç–æ–ª–æ–∫
                ('CONS-AVR-001', ['–≤–æ–¥–∞', '–ø—Ä–æ—Ç–µ—á–∫–∞', '—Ç–µ—á—å', '–ø–æ—Ç–æ–ª–æ–∫']),
            ]

            for scenario_id, tag_names in tag_service_links:
                for tag_name in tag_names:
                    cursor.execute("""
                        INSERT INTO service_tags (service_id, tag_id, tag_weight)
                        SELECT sc.service_id, rt.tag_id, 1.0
                        FROM services_catalog sc
                        JOIN ref_tags rt ON rt.tag_name = %s
                        WHERE sc.scenario_id = %s
                        ON CONFLICT DO NOTHING
                    """, [tag_name, scenario_id])

            print("‚úÖ –°–≤—è–∑–∏ —Ç–µ–≥–æ–≤ —Å —É—Å–ª—É–≥–∞–º–∏ —Å–æ–∑–¥–∞–Ω—ã")

            print("üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è AI...")

            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç—ã
            cursor.execute("""
                INSERT INTO prompt_templates
                (template_code, template_name, user_prompt_template, system_prompt, is_active)
                VALUES ('SERVICE_LOOKUP', '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é', %s, %s, TRUE)
                ON CONFLICT DO NOTHING
            """, [
                # User prompt template
                """–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–∞–∫: {category}

–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{message}"

{services_context}

–í—ã–±–µ—Ä–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é —É—Å–ª—É–≥—É –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞. –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:
{
  "scenario_id": "XXX-YYY-ZZZ",
  "scenario_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏",
  "confidence": 0.95,
  "reason": "–ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω–∞ —ç—Ç–∞ —É—Å–ª—É–≥–∞"
}""",

                # System prompt
                """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç-–¥–∏—Å–ø–µ—Ç—á–µ—Ä —É–ø—Ä–∞–≤–ª—è—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –ñ–ö–• "–ê—Å–ø–µ–∫—Ç" —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —É—Å–ª—É–≥–∏ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é –ø—Ä–æ–±–ª–µ–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ü—Ä–∞–≤–∏–ª–∞:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
2. –£—á—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å—Ä–æ—á–Ω–æ—Å—Ç—å
3. –í—ã–±–µ—Ä–∏ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é —É—Å–ª—É–≥—É –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
4. –í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON
5. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π (0.5-0.95)
6. –í –ø–æ–ª–µ reason –æ–±—ä—è—Å–Ω–∏ –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞

–ü—Ä–∏–º–µ—Ä—ã:
- "—Ç–µ—á–µ—Ç –∏–∑ –∫—Ä–∞–Ω–∞" ‚Üí WAT-S2-001 (–£—Ç–µ—á–∫–∞ –∏–∑ –∫—Ä–∞–Ω–∞)
- "–Ω–µ—Ç —Å–≤–µ—Ç–∞" ‚Üí EL-AVR-001 (–ù–µ—Ç —Å–≤–µ—Ç–∞ –≤–æ –≤—Å–µ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ)
- "–∑–∞–±–∏–ª–∞—Å—å —Ä–∞–∫–æ–≤–∏–Ω–∞" ‚Üí WAT-S2-002 (–ó–∞—Å–æ—Ä —Ä–∞–∫–æ–≤–∏–Ω—ã)

–ë—É–¥—å —Ç–æ—á–µ–Ω –∏ –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω –∫ –¥–µ—Ç–∞–ª—è–º!"""
            ])

            print("‚úÖ –ü—Ä–æ–º–ø—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã")

            print("üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ —É—Å–ª—É–≥...")

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            cursor.execute("SELECT fn_init_service_catalog()")
            result = cursor.fetchone()
            print(f"‚úÖ –°—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: {result}")

            print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã!")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
        raise

if __name__ == '__main__':
    add_test_data()